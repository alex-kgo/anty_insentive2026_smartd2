# [DECISIONS.MD](http://decisions.md/)

로지 PC 프로그램에서 월 단위로 일자별 데이터를 조회하여 “엑셀로 보기”로 Export하고,
상담원별 콜 데이터를 스프레드시트에 누적한 뒤,
월 취합 CSV를 Export하여 텔레그램으로 전송하는 자동화 시스템의 핵심 의사결정 문서.

작성일: 2026-02-19
구현 방식: UI 자동화(RPA, Antigravity) + Excel 데이터 파싱 + Spreadsheet 누적 + CSV Export + Telegram 전송

---

## 0) 시스템 목표

### 목적

사용자가 지정한 취합 월(YYYY-MM)에 대해 다음을 자동으로 수행한다.

1. 로지 프로그램 로그인
2. 해당 월의 모든 날짜에 대해 “기간(시작/종료)”을 설정하여 조회
3. “엑셀로 보기”로 Excel을 열어 데이터 확보
4. Excel의 상담원별 데이터를 정규화하여 스프레드시트에 누적(Upsert)
5. 월 취합 결과를 CSV로 Export
6. 텔레그램으로 CSV 파일 전송(요약 포함)

### 결과물(핵심 산출)

- 스프레드시트 누적 데이터(일자/상담원 단위)
- 월 취합 CSV 파일
- 텔레그램 전송 기록(성공/실패 로그)

### 비범위(초기)

- 인센티브 계산 “정책/산식” 자체 자동화는 제외(기초 원천 데이터 생성에 집중)
- 로지 UI 대규모 변경에 대한 자동 적응(업데이트 시 유지보수 필요)

---

## 1) 실행 환경 의사결정

### D1. API 미제공 → UI 자동화 확정

- 로지 프로그램은 API 제공하지 않음(확정)
- 따라서 UI 기반 RPA 방식으로 구현한다.
- 리스크: UI 변경/포커스/해상도 영향
- 대응: UI Automation 기반 컨트롤 탐색 우선, 좌표 클릭은 최후 수단

### D2. 실행 환경 고정

- 전용 Windows PC 또는 전용 VM 사용
- 해상도 1920x1080 고정
- 디스플레이 배율 100% 고정
- 실행 중 사용자 마우스/키보드 개입 금지(또는 실행 시간대 분리)

### D3. 실행 계정/스케줄

- 전용 OS 계정 사용
- Antigravity 데몬 또는 작업 스케줄러로 실행
- 운영 시간대는 로지 사용량이 적은 시간(야간/이른 오전) 권장

---

## 2) 입력 스펙

### D4. 입력값

- 취합 월(YYYY-MM) 단일 입력
- 예: 2026-02 → 2026-02-01 ~ 2026-02-28/29 자동 루프
- (부분 일자 취합은 2차 확장 범위)

### D-NEW4. 좌표 설정 방식 개선 (2026-02-19 추가)

- **상대 좌표(Relative Coordinates)**: 윈도우 창 위치가 변경되어도 동작하도록, 전체 화면 좌표가 아닌 **로지 프로그램 창 내부 기준** 좌표를 사용한다.
- **세분화된 날짜 입력**: 날짜 입력 컨트롤 인식 문제 해결을 위해 시작/종료 각각의 년, 월, 일, 시간(Hour) 입력 위치를 개별 좌표로 설정한다.

---

## 3) 로지 로그인/보안 의사결정

### D5. 로지 로그인 창 구조(참고)

- SMART DII (Ver. 18.94)
- 아이디, 비밀번호, 로그인 버튼
- ID저장 체크박스 존재

### D6. 자격 증명 저장 정책

- 로지 ID/PW는 코드/문서에 평문 저장 금지
- Windows Credential Manager 또는 Secret Vault(환경변수/보안 저장소) 사용

### D7. Telegram 자격 증명

- Bot Token/Chat ID도 동일하게 Secret로 관리
- 전송 대상 Chat ID는 화이트리스트로 제한

---

## 4) 로지 조회 조건 설계(기간/시간 정책 최종)

### D8. 기간 입력 필드 구조 확정

- 로지 조회 조건은 `기간 시작(YYYY-MM-DD HH:MM)` / `기간 종료(YYYY-MM-DD HH:MM)` 2개 필드로 구성된다.
- 각 날짜 조회 시 두 필드를 반드시 재설정한다(잔존값 방지).

### D9. 시간/기간 정책(최종 확정)

- UI 제약상 “분 단위 변경 불가”, “시간 단위로만 변경 가능”(확정)
- 따라서 “하루 집계”는 아래로 고정한다.

**하루 범위 고정**

- 시작: 해당일 00:00
- 종료: 다음날 00:00 (+1일 00:00)

예) 2026-02-18 집계

- 시작: 2026-02-18 00:00
- 종료: 2026-02-19 00:00

### D10. 기간 입력 표준 절차(강제)

- 매 일자 루프마다:
    - 시작 입력칸: Ctrl+A → 값 입력 → Enter
    - 종료 입력칸: Ctrl+A → 값 입력 → Enter
- 이 절차는 필수(이전 값 잔존으로 인한 누락 방지 목적)

### D11. 옵션 체크박스 강제

- `전화발신건수기준` 체크박스는 집계에 영향을 줄 수 있으므로
매 실행/매 일자 조회마다 목표 상태(ON/OFF)를 강제 세팅한다.
- 목표 상태는 설정값으로 관리(초기 기본값: ON)

### D12. 조회 트리거 및 완료 판정

- 조회는 `조회(V)` 버튼으로 수행한다.
- 완료 판정은 다음 중 1개 이상 신호로 확인:
    - 로딩 스피너 종료
    - 결과 그리드 row count 확정(2회 연속 동일)
    - “조회 결과/합계” 영역 변화 감지
- 단순 sleep 기반 대기는 실패율이 높아 금지(보조로만 제한)

---

## 5) 엑셀 Export 처리(“엑셀로 보기”)

### D13. 엑셀로 보기 동작 구조

- “엑셀로 보기” 클릭 시 Excel이 별도 프로세스로 열린다.
- UI 상 버튼이 아닌 컨텍스트/메뉴 형태일 수 있으므로:
    - 그리드 포커스 확보 → 메뉴 호출 → ‘엑셀로 보기’ 선택
    흐름을 표준으로 한다.

### D14. 다운로드/저장 폴더(운영 표준)

- Export 파일을 저장하는 경우, 폴더를 고정:
    - C:\RPA\logi_exports\raw\
- 파싱 성공 시:
    - C:\RPA\logi_exports\processed\ 로 이동
- 파싱 실패 시:
    - C:\RPA\logi_exports\error\ 로 이동

---

## 6) 엑셀 데이터 파싱/정규화(최종)

### D-NEW5. 엑셀 연결 방식 개선 (2026-02-19 추가)

- **문제**: Excel 2016 및 로지 프로그램이 생성하는 엑셀 프로세스가 외부로 잘 노출되지 않는 문제(일반 `xlwings` 연결 실패).
- **해결**: Windows **ROT(Running Object Table)**를 순회하여 실행 중인 엑셀 객체("Book", "Excel", "통합 문서" 등)를 직접 찾아 연결하는 방식(`pywin32` 활용)으로 변경. 이는 "통합 문서1", "통합 문서2" 등 가변적인 이름도 모두 지원한다.
- **인증 마법사 처리**: 엑셀 실행 시 발생하는 "인증 마법사" 팝업을 닫기 위해 별도 좌표 설정을 지원한다.

### D15. 엑셀 컬럼(캡처 기준) 확정

- A: 코드
- B: 성명
- C: 고객(받음)
- D: 기사(받음)
- E: 고객(걸음)
- F: 기사(걸음)
- G: 합계(건) (참고용 — 시스템은 아래 계산식으로 재계산하여 사용)

### D16. 스프레드시트 누적 컬럼(최종)

스프레드시트에 누적할 컬럼은 아래 순서로 고정한다.

1. 날짜 (YYYY-MM-DD) ※ 루프 날짜를 강제 주입
2. 코드
3. 성명
4. 수신 합계
5. 발신 합계
6. 총합계

### D17. 계산 규칙(최종)

- 수신 합계 = 고객(받음) + 기사(받음)
- 발신 합계 = 고객(걸음) + 기사(걸음)
- 총합계 = 수신 합계 + 발신 합계

구체식(정수 변환 포함)

- 수신 합계 = int(C) + int(D)
- 발신 합계 = int(E) + int(F)
- 총합계 = 수신 합계 + 발신 합계

파싱 규칙

- 빈칸/공백/NULL은 0으로 처리
- 숫자 변환 실패 시 해당 셀은 0 처리 + WARN 로그
- 날짜는 엑셀 값이 아닌 “루프 날짜”를 신뢰한다.

---

## 7) 스프레드시트 적재(누적/중복 방지)

### D18. 적재 단위

- 일자 단위 배치 적재(하루 데이터 파싱 완료 후 한 번에 업로드)

### D19. 멱등성/중복 방지 키

- 유니크 키: 날짜 + 코드
- 동일 키 존재 시 업데이트(덮어쓰기)
- 동일 취합월 재실행 시에도 데이터가 망가지지 않게 보장

### D20. 시트 구조(확정)

## 🔹 년월별 시트(Tab) 생성 정책

### D-NEW1. 시트명 규칙

시트명 = `YYYY-MM`

예:

- 2026-01
- 2026-02
- 2026-03

### D-NEW2. 동작 방식

- 해당 년월 시트가 존재하면 → 해당 시트에 누적
- 존재하지 않으면 → 자동 생성 후 헤더 작성

### D-NEW3. 헤더 구조 (고정)

각 년월 시트의 헤더는 다음과 같다:

| 날짜 | 코드 | 성명 | 수신 합계 | 발신 합계 | 총합계 |

---

## 8) CSV Export

### D21. CSV 파일명 규칙

- logi_calls_{YYYY-MM}_{YYYYMMDD-HHMM}.csv

예:
logi_calls_2026-02_20260219-0630.csv

### D22. 인코딩 정책

- UTF-8 기본
- Excel 호환 필요 시 UTF-8 BOM 옵션 제공

---

## 9) 텔레그램 전송

### D23. 전송 형식

- CSV 파일을 Document로 전송
- 메시지 본문에 요약 포함(월/총 행수/상태)

예:
[로지 월 취합 완료]
월: 2026-02
총 행수: 1,284
상태: SUCCESS

### D24. 재시도 정책

- 최대 3회 재시도
- 지수 백오프 적용
- 최종 실패 시:
    - CSV 파일 로컬 보관
    - ExportLogs에 FAIL 기록 + 사유 기록

---

## 10) 오류 처리/복구/감사(운영 안정성)

### D25. 체크포인트(진행 상태) 저장

- 월 단위 실행 상태를 로컬 JSON으로 기록:
    - 마지막 성공 처리 일자
    - 실패 일자 목록
    - 마지막 성공 Export 파일명
- 중단 시 이어서 실행 가능(재실행 = 복구)

### D26. 스크린샷/로그 정책

- UI 단계 실패 시 자동 스크린샷 저장:
    - C:\RPA\logi_exports\logs\screens\YYYYMM\
- 로그 레벨:
    - INFO: 일자 시작/종료, 행수
    - WARN: 일부 행 스킵/숫자 변환 실패
    - ERROR: 로그인 실패/조회 실패/엑셀 열기 실패/파싱 실패/시트 적재 실패/텔레그램 전송 실패

---

## 11) 성능/운영 정책

### D27. 병렬 처리 금지(초기)

- UI 자동화 특성상 직렬 처리만 허용
- 안정성 우선

### D28. 실행 시간대 권장

- 로지 프로그램 사용량이 적은 시간(야간/이른 오전) 권장

---

## 12) 미해결/확인 필요(구현 시점 체크리스트)

- “엑셀로 보기” 실행 시 실제로 파일 저장이 발생하는지, 아니면 엑셀만 열리는지 → 엑셀만 열림
- Excel에서 데이터가 항상 동일 시트/동일 헤더로 제공되는지 → 동일시트,동일헤더로 제공됨
- 스프레드시트 대상이 Google Sheets인지(권한/서비스계정 방식 확정 필요) → 구글시트
- 텔레그램 대상이 개인/그룹/채널인지 및 Chat ID 확정 → 확정됨 env로 저장하여 활용

---

## 13) 변경 이력

- 2026-02-19: 초안 작성
- 2026-02-19: API 미제공 확정 반영
- 2026-02-19: 시간/기간 제약 반영(분 단위 불가 → “해당일 00:00 ~ 다음날 00:00” 고정)
- 2026-02-19: 스프레드시트 누적 컬럼/계산 규칙 최종 반영
- 2026-02-19: 좌표 설정(상대좌표, 세분화), 엑셀 연동(ROT, 인증팝업) 개선 반영